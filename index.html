<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nguyễn Tiêu - CHAT AI</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500&display=swap');

        :root {
            --bg-body: #131314;
            --text-main: #e3e3e3;
            --text-sub: #c4c7c5;
            --input-bg: #1e1e20;
            --input-border: #3c4043;
            --ai-accent: #8ab4f8;
            --user-accent: #c4c7c5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Google Sans', Roboto, Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        nav {
            padding: 16px 24px;
            display: flex;
            justify-content: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .nav-brand {
            font-size: 18px;
            font-weight: 500;
            color: var(--ai-accent);
        }

        main {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
        }

        .chat-container {
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 85%;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Bố cục bên trái cho AI */
        .ai-message {
            align-self: flex-start;
            align-items: flex-start;
        }

        /* Bố cục bên phải cho Người dùng */
        .user-message {
            align-self: flex-end;
            align-items: flex-end;
        }

        .sender-name {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ai-message .sender-name { color: var(--ai-accent); }
        .user-message .sender-name { color: var(--user-accent); }

        .bubble {
            line-height: 1.6;
            font-size: 16px;
            word-wrap: break-word;
        }

        .user-message .bubble {
            background: #2b2d31;
            padding: 12px 18px;
            border-radius: 20px 20px 4px 20px;
            color: #fff;
        }

        .ai-message .bubble {
            padding: 4px 0;
            color: var(--text-main);
        }

        /* Shimmer Loading */
        .shimmer {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 200px;
            padding: 10px 0;
        }

        .shimmer-line {
            height: 12px;
            border-radius: 2px;
            background: linear-gradient(90deg, #1e1e20 25%, #2d2d30 50%, #1e1e20 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        footer {
            padding: 16px;
            background: var(--bg-body);
        }

        .input-wrapper {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            background: var(--input-bg);
            border-radius: 28px;
            padding: 4px 8px 4px 20px;
            display: flex;
            align-items: center;
            border: 1px solid var(--input-border);
        }

        input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-main);
            font-size: 16px;
            padding: 12px 0;
        }

        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--text-sub);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn.active { color: var(--ai-accent); }

        .disclaimer {
            text-align: center;
            font-size: 11px;
            color: #8e918f;
            margin-top: 12px;
        }

        /* Markdown blocks */
        .bubble p { margin-bottom: 12px; }
        .bubble pre { background: #000; padding: 14px; border-radius: 8px; margin: 10px 0; overflow-x: auto; }
        .bubble code { font-family: monospace; color: #8ab4f8; }
    </style>
</head>
<body>

    <nav>
        <div class="nav-brand">Nguyễn Tiêu AI</div>
    </nav>

    <main id="scroller">
        <div class="chat-container" id="chat-box">
            <!-- Tin nhắn mẫu -->
            <div class="message ai-message">
                <span class="sender-name">Nguyễn Tiêu AI</span>
                <div class="bubble">Chào bạn! Tôi có thể giúp gì cho bạn hôm nay?</div>
            </div>
        </div>
    </main>

    <footer>
        <div class="input-wrapper">
            <input type="text" id="user-input" placeholder="Hỏi Nguyễn Tiêu AI..." autocomplete="off">
            <button class="send-btn" id="send-trigger" onclick="App.sendMessage()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
            </button>
        </div>
        <p class="disclaimer">Tin nhắn được bảo mật riêng tư giữa bạn và AI.</p>
    </footer>

    <script>
        const firebaseConfig = JSON.parse(__firebase_config);
        const apiKey = ""; // Sẽ được hệ thống điền tự động

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'nguyen-tieu-minimal';

        window.App = {
            uid: null,
            history: [],

            async init() {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        this.uid = user.uid;
                        this.loadHistory();
                    } else {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    }
                });

                const input = document.getElementById('user-input');
                const btn = document.getElementById('send-trigger');
                input.oninput = () => btn.classList.toggle('active', input.value.trim() !== "");
                input.onkeydown = (e) => { if (e.key === 'Enter') this.sendMessage(); };
            },

            async loadHistory() {
                const path = `/artifacts/${appId}/users/${this.uid}/messages`;
                const snap = await db.collection(path).orderBy('timestamp', 'asc').limit(30).get();
                if (!snap.empty) {
                    const box = document.getElementById('chat-box');
                    box.innerHTML = '';
                    snap.forEach(doc => {
                        const d = doc.data();
                        this.renderUI(d.role, d.text);
                        this.history.push({ role: d.role === 'ai' ? 'model' : 'user', parts: [{ text: d.text }] });
                    });
                    this.scroll();
                }
            },

            renderUI(role, text, isStreaming = false) {
                const box = document.getElementById('chat-box');
                const div = document.createElement('div');
                div.className = `message ${role}-message`;
                
                const name = role === 'ai' ? 'Nguyễn Tiêu AI' : 'Bạn';
                div.innerHTML = `
                    <span class="sender-name">${name}</span>
                    <div class="bubble">${isStreaming && role === 'ai' ? '' : marked.parse(text)}</div>
                `;
                
                box.appendChild(div);
                this.scroll();
                if (isStreaming && role === 'ai') return div.querySelector('.bubble');
            },

            scroll() {
                const s = document.getElementById('scroller');
                s.scrollTop = s.scrollHeight;
            },

            async sendMessage() {
                const input = document.getElementById('user-input');
                const text = input.value.trim();
                if (!text || !this.uid) return;

                input.value = '';
                document.getElementById('send-trigger').classList.remove('active');

                // Render User message (Bên phải)
                this.renderUI('user', text);
                
                // Hiển thị Shimmer loading (Bên trái)
                const box = document.getElementById('chat-box');
                const loader = document.createElement('div');
                loader.className = 'message ai-message';
                loader.id = 'loader';
                loader.innerHTML = `
                    <span class="sender-name">Nguyễn Tiêu AI</span>
                    <div class="shimmer">
                        <div class="shimmer-line" style="width:100%"></div>
                        <div class="shimmer-line" style="width:60%"></div>
                    </div>
                `;
                box.appendChild(loader);
                this.scroll();

                try {
                    const path = `/artifacts/${appId}/users/${this.uid}/messages`;
                    await db.collection(path).add({ role: 'user', text: text, timestamp: Date.now() });

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [...this.history, { role: 'user', parts: [{ text: text }] }],
                            systemInstruction: { parts: [{ text: "Tên bạn là Nguyễn Tiêu AI. Hãy trả lời cực kỳ thông minh, súc tích, định dạng Markdown đẹp. Tin nhắn người dùng nằm bên phải, tin nhắn của bạn nằm bên trái. Bạn không có avatar, chỉ có tên hiển thị." }] }
                        })
                    });

                    const data = await response.json();
                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Lỗi phản hồi.";

                    document.getElementById('loader').remove();
                    
                    const bubble = this.renderUI('ai', aiText, true);
                    let i = 0;
                    const itv = setInterval(() => {
                        bubble.innerHTML = marked.parse(aiText.substring(0, i + 1));
                        i++;
                        this.scroll();
                        if (i >= aiText.length) clearInterval(itv);
                    }, 5);

                    await db.collection(path).add({ role: 'ai', text: aiText, timestamp: Date.now() });
                    this.history.push({ role: 'user', parts: [{ text: text }] }, { role: 'model', parts: [{ text: aiText }] });

                } catch (e) {
                    if(document.getElementById('loader')) document.getElementById('loader').remove();
                    this.renderUI('ai', "Đã xảy ra lỗi kết nối.");
                }
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>

